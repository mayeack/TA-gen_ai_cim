#
# transforms.conf - Field extractions and transformations
# TA-gen_ai_cim
#
# Handles JSON array extractions for multi-value field creation.
# Note: Nested JSON object extraction is handled by KV_MODE=json in props.conf.
#
# Compatible with: Splunk Enterprise 9.0+, Splunk Cloud
#

###############################################################################
# MULTI-VALUE FIELD EXTRACTIONS
# Extract array elements from JSON arrays as multi-value fields
###############################################################################

# Extract safety categories from JSON array
# Example: "safety_categories": ["High severity level: EMERGENCY", "VIOLENCE"]
[extract_safety_categories]
SOURCE_KEY = safety_categories
REGEX = "([^"]+)"
FORMAT = gen_ai.safety.categories::$1
MV_ADD = true

# Extract guardrail IDs from JSON array
# Example: "guardrail_ids": ["escalation_rules", "content_filter"]
[extract_guardrail_ids]
SOURCE_KEY = guardrail_ids
REGEX = "([^"]+)"
FORMAT = gen_ai.guardrail.ids::$1
MV_ADD = true

# Alternative extraction for nested event format
[extract_guardrail_ids_alt]
SOURCE_KEY = event.guardrails_triggered
REGEX = "([^"]+)"
FORMAT = gen_ai.guardrail.ids::$1
MV_ADD = true

# Extract PII types from JSON array
# Example: "pii_types": ["SSN", "EMAIL", "PHONE"]
[extract_pii_types]
SOURCE_KEY = pii_types
REGEX = "([^"]+)"
FORMAT = gen_ai.pii.types::$1
MV_ADD = true

# Extract finish reasons from JSON array
# Example: "response_finish_reasons": ["end_turn", "stop"]
[extract_finish_reasons]
SOURCE_KEY = response_finish_reasons
REGEX = "([^"]+)"
FORMAT = gen_ai.response.finish_reasons::$1
MV_ADD = true

# Extract stop sequences from JSON array
# Example: "request_stop_sequences": ["\n\n", "END"]
[extract_stop_sequences]
SOURCE_KEY = request_stop_sequences
REGEX = "([^"]+)"
FORMAT = gen_ai.request.stop_sequences::$1
MV_ADD = true

###############################################################################
# MLTK-ENHANCED FIELDS (Documentation)
###############################################################################

# These fields are populated by MLTK scoring searches defined in savedsearches.conf:
#
# gen_ai.pii.risk_score - PII detection probability (0-1)
# gen_ai.pii.ml_detected - MLTK-based PII detection flag
# gen_ai.prompt_injection.risk_score - Prompt injection probability (0-1)
# gen_ai.prompt_injection.ml_detected - MLTK-based prompt injection flag
# gen_ai.prompt.anomaly_score - TF-IDF anomaly score for prompts
# gen_ai.response.anomaly_score - TF-IDF anomaly score for responses

###############################################################################
# LOOKUP TABLE DEFINITIONS
###############################################################################

# PII training examples for model training
[pii_training_examples]
filename = pii_training_examples.csv
case_sensitive_match = false

# PII model metadata (accuracy, version, etc.)
[pii_model_metadata]
filename = pii_model_metadata.csv
case_sensitive_match = false

# Engineered training data (generated from pii_training_examples)
[pii_training_data_engineered]
filename = pii_training_data_engineered.csv
case_sensitive_match = false

# Large-scale PII training dataset (200k examples)
[llm_pii_mixed_responses_200k]
filename = llm_pii_mixed_responses_200k.csv
case_sensitive_match = false

# Prompt injection training examples for model training
[prompt_injection_training_examples]
filename = prompt_injection_training_examples.csv
case_sensitive_match = false

# Engineered training data for prompt injection (generated from prompt_injection_training_examples)
[prompt_injection_training_data_engineered]
filename = prompt_injection_training_data_engineered.csv
case_sensitive_match = false

# Prompt injection model metadata (accuracy, version, etc.)
[prompt_injection_model_metadata]
filename = prompt_injection_model_metadata.csv
case_sensitive_match = false

# TF-IDF anomaly detection training data (curated normal prompts/responses)
# Contains curated "normal" examples for OneClassSVM training
[tfidf_training_data_v3]
filename = tfidf_training_data_v3.csv
case_sensitive_match = false

###############################################################################
# KV STORE LOOKUP DEFINITIONS
###############################################################################

# Token cost lookup - time-versioned pricing by provider/model/direction
# Use this lookup to retrieve cost_per_million for token cost calculations
# The lookup supports time-based filtering via effective_start/effective_end
[genai_token_cost_lookup]
external_type = kvstore
collection = genai_token_cost
fields_list = _key, provider, model, direction, cost_per_million, effective_start, effective_end, currency
case_sensitive_match = false

# ServiceNow AI Case mapping lookup - maps gen_ai.event.id to ServiceNow sys_id
# Use this lookup to check if a case already exists for a given event
[gen_ai_snow_case_map_lookup]
external_type = kvstore
collection = gen_ai_snow_case_map
fields_list = _key, event_id, sys_id, sn_instance, created_at, updated_at, created_by
case_sensitive_match = true

###############################################################################
# REVIEW FINDINGS LOOKUP
# Maps review findings back to events via gen_ai_event_id
# Field names use underscore format for KV Store REST API compatibility
###############################################################################

[gen_ai_review_findings_lookup]
external_type = kvstore
collection = gen_ai_review_findings
fields_list = _key, gen_ai_event_id, gen_ai_trace_id, event_time, gen_ai_app_name, gen_ai_request_model, gen_ai_input_preview, gen_ai_output_preview, gen_ai_review_reviewer, gen_ai_review_assignee, gen_ai_review_status, gen_ai_review_priority, gen_ai_review_pii_confirmed, gen_ai_review_pii_types, gen_ai_review_pii_types_reviewed, gen_ai_review_phi_confirmed, gen_ai_review_phi_types, gen_ai_review_prompt_injection_confirmed, gen_ai_review_prompt_injection_type, gen_ai_review_anomaly_prompt_detected, gen_ai_review_anomaly_prompt_reviewed, gen_ai_review_anomaly_response_detected, gen_ai_review_anomaly_response_reviewed, gen_ai_review_notes, gen_ai_review_created_at, gen_ai_review_updated_at, gen_ai_review_created_by, gen_ai_review_updated_by
case_sensitive_match = false

###############################################################################
# REVIEW AUDIT LOG LOOKUP
# Access audit trail for review actions
###############################################################################

[gen_ai_review_audit_lookup]
external_type = kvstore
collection = gen_ai_review_audit
fields_list = _key, audit_id, event_id, action, previous_status, new_status, changed_fields, user, timestamp, notes
case_sensitive_match = false

###############################################################################
# PII FEEDBACK LOOP LOOKUP DEFINITIONS
###############################################################################

# PII Model Registry - Track model versions and performance metrics
[pii_model_registry_lookup]
external_type = kvstore
collection = pii_model_registry
fields_list = _key, model_name, model_version, algorithm, feature_count, accuracy, precision, recall, f1_score, threshold, training_samples, pii_samples, clean_samples, feedback_samples, status, created_at, promoted_at, retired_at, created_by, promoted_by, notes
case_sensitive_match = false

# PII Training Feedback - Human-labeled data for model retraining
[pii_training_feedback_lookup]
external_type = kvstore
collection = pii_training_feedback
fields_list = _key, event_id, trace_id, response_text, response_length, pii_label, pii_types, pii_types_reviewed, has_ssn_label, has_email_label, has_phone_label, has_dob_label, has_address_label, has_credit_card_label, has_name_label, phi_confirmed, reviewer, review_completed_at, ml_predicted_score, ml_predicted_label, ml_predicted_types, ml_model_version, feedback_type, split_assignment, output_length, word_count, digit_ratio, special_char_ratio, uppercase_ratio, has_ssn, has_email, has_phone, has_dob, has_address, has_credit_card, has_name, extracted_at, app_name, model_name
case_sensitive_match = false

# PII Threshold Results - Threshold tuning analysis results
[pii_threshold_results_lookup]
external_type = kvstore
collection = pii_threshold_results
fields_list = _key, model_name, model_version, analysis_date, threshold, true_positives, false_positives, true_negatives, false_negatives, precision, recall, f1_score, accuracy, specificity, total_samples, validation_samples, is_optimal, notes
case_sensitive_match = false

###############################################################################
# PROMPT INJECTION FEEDBACK LOOP LOOKUP DEFINITIONS
###############################################################################

# Prompt Injection Model Registry - Track model versions and performance metrics
[prompt_injection_model_registry_lookup]
external_type = kvstore
collection = prompt_injection_model_registry
fields_list = _key, model_name, model_version, algorithm, feature_count, accuracy, precision, recall, f1_score, threshold, training_samples, attack_samples, clean_samples, feedback_samples, status, created_at, promoted_at, retired_at, created_by, promoted_by, notes
case_sensitive_match = false

# Prompt Injection Training Feedback - Human-labeled data for model retraining
[prompt_injection_training_feedback_lookup]
external_type = kvstore
collection = prompt_injection_training_feedback
fields_list = _key, event_id, trace_id, input_text, prompt_length, injection_label, injection_technique, technique_reviewed, has_ignore_instruction_label, has_reveal_request_label, has_bypass_request_label, has_roleplay_injection_label, has_jailbreak_terms_label, has_encoding_label, reviewer, review_completed_at, ml_predicted_score, ml_predicted_label, ml_predicted_technique, ml_model_version, feedback_type, split_assignment, word_count, special_char_ratio, negation_density, has_ignore_instruction, has_reveal_request, has_bypass_request, has_roleplay_injection, has_jailbreak_terms, has_encoding, starts_with_command, extracted_at, app_name, model_name
case_sensitive_match = false

# Prompt Injection Threshold Results - Threshold tuning analysis results
[prompt_injection_threshold_results_lookup]
external_type = kvstore
collection = prompt_injection_threshold_results
fields_list = _key, model_name, model_version, analysis_date, threshold, true_positives, false_positives, true_negatives, false_negatives, precision, recall, f1_score, accuracy, specificity, total_samples, validation_samples, is_optimal, notes
case_sensitive_match = false

###############################################################################
# TF-IDF ANOMALY FEEDBACK LOOP LOOKUP DEFINITIONS
###############################################################################

# TF-IDF Model Registry - Track model versions and performance metrics
[tfidf_model_registry_lookup]
external_type = kvstore
collection = tfidf_model_registry
fields_list = _key, model_name, model_type, model_version, algorithm, feature_count, precision, recall, f1_score, threshold, training_samples, feedback_samples, original_samples, status, created_at, promoted_at, retired_at, created_by, promoted_by, notes
case_sensitive_match = false

# TF-IDF Training Feedback - Human-confirmed normal data for model retraining
# Only contains records where reviewer marked FALSE (True Negative)
[tfidf_training_feedback_lookup]
external_type = kvstore
collection = tfidf_training_feedback
fields_list = _key, gen_ai_event_id, trace_id, feedback_timestamp, prompt_text, response_text, has_prompt_feedback, has_response_feedback, app_name, model_name, split_assignment, reviewer, review_completed_at
case_sensitive_match = false

# TF-IDF Threshold Results - Threshold tuning analysis results
[tfidf_threshold_results_lookup]
external_type = kvstore
collection = tfidf_threshold_results
fields_list = _key, model_name, model_type, model_version, analysis_date, threshold, total_samples, anomaly_count, normal_count, anomaly_rate, avg_score, std_score, min_score, max_score, p10_score, p50_score, p90_score, is_optimal, notes
case_sensitive_match = false

###############################################################################
# SERVICENOW AI SYSTEM DIGITAL ASSET LOOKUP
###############################################################################

# ServiceNow AI System Digital Asset mapping lookup
# Maps gen_ai.app.name to ServiceNow alm_ai_system_digital_asset sys_id
[gen_ai_app_asset_map_lookup]
external_type = kvstore
collection = gen_ai_app_asset_map
fields_list = _key, gen_ai_app_name, service_now_sys_id, sync_status, created_at, updated_at, created_by
case_sensitive_match = false
