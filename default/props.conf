#
# props.conf - Search-time field extractions and normalizations
# TA-gen_ai_cim
#
# This configuration applies search-time normalization to events in gen_ai_cim related indexes.
# Normalizes provider-specific fields into the unified gen_ai.* namespace based on OTel semantic conventions.
#
# IMPORTANT: This TA provides SEARCH-TIME extractions only.
# Index-time settings (INDEXED_EXTRACTIONS, TIMESTAMP_FIELDS, etc.) should be configured
# in the inputs/props on the indexers or Heavy Forwarders, not here.
#
# Compatible with: Splunk Enterprise 9.0+, Splunk Cloud
#

###############################################################################
# INDEX-BASED NORMALIZATION (Primary - applies to all events in gen_ai_log)
###############################################################################

[index::gen_ai_log]
# Search-time JSON field extraction for all events in this index
KV_MODE = json

#-----------------------------------------------------------------------------
# Core Operation & Model Identity
#-----------------------------------------------------------------------------
FIELDALIAS-idx_operation_name = operation_name AS gen_ai.operation.name
FIELDALIAS-idx_provider_name = provider_name AS gen_ai.provider.name
FIELDALIAS-idx_request_model = request_model AS gen_ai.request.model
FIELDALIAS-idx_response_model = response_model AS gen_ai.response.model
FIELDALIAS-idx_response_id = response_id AS gen_ai.response.id
FIELDALIAS-idx_conversation_id = conversation_id AS gen_ai.conversation.id
FIELDALIAS-idx_deployment_id = deployment_id AS gen_ai.deployment.id
FIELDALIAS-idx_request_id = request_id AS gen_ai.request.id
FIELDALIAS-idx_session_id = session_id AS gen_ai.session.id
FIELDALIAS-idx_event_id = event_id AS gen_ai.event.id
FIELDALIAS-idx_trace_id = trace_id AS trace_id

#-----------------------------------------------------------------------------
# Input/Output Payload
#-----------------------------------------------------------------------------
FIELDALIAS-idx_system_instructions = system_instructions AS gen_ai.system_instructions
FIELDALIAS-idx_output_type = output_type AS gen_ai.output.type
FIELDALIAS-idx_input_raw = input_messages AS gen_ai.input.messages_raw
FIELDALIAS-idx_output_raw = output_messages AS gen_ai.output.messages_raw

# Extract text content from JSON array messages
EVAL-gen_ai.input.messages = case( \
    isnotnull('input_messages{}.content'), mvjoin('input_messages{}.content', " "), \
    isnotnull(input_messages), input_messages, \
    1=1, null())
EVAL-gen_ai.output.messages = case( \
    isnotnull('output_messages{}.content'), mvjoin('output_messages{}.content', " "), \
    isnotnull(output_messages), output_messages, \
    1=1, null())

#-----------------------------------------------------------------------------
# Request Parameters
#-----------------------------------------------------------------------------
FIELDALIAS-idx_token_type = token_type AS gen_ai.token.type
FIELDALIAS-idx_max_tokens = request_max_tokens AS gen_ai.request.max_tokens
FIELDALIAS-idx_temperature = request_temperature AS gen_ai.request.temperature
FIELDALIAS-idx_top_p = request_top_p AS gen_ai.request.top_p
FIELDALIAS-idx_frequency_penalty = request_frequency_penalty AS gen_ai.request.frequency_penalty
FIELDALIAS-idx_presence_penalty = request_presence_penalty AS gen_ai.request.presence_penalty
FIELDALIAS-idx_stop_sequences = request_stop_sequences AS gen_ai.request.stop_sequences
FIELDALIAS-idx_finish_reasons = response_finish_reasons AS gen_ai.response.finish_reasons
FIELDALIAS-idx_choice_count = request_choice_count AS gen_ai.request.choice.count
FIELDALIAS-idx_seed = request_seed AS gen_ai.request.seed

#-----------------------------------------------------------------------------
# Usage, Performance, Cost
#-----------------------------------------------------------------------------
FIELDALIAS-idx_input_tokens = usage_input_tokens AS gen_ai.usage.input_tokens
FIELDALIAS-idx_output_tokens = usage_output_tokens AS gen_ai.usage.output_tokens
FIELDALIAS-idx_duration = client_operation_duration AS gen_ai.client.operation.duration
FIELDALIAS-idx_cost = cost AS gen_ai.cost.total

# Computed: total tokens = input + output
EVAL-gen_ai.usage.total_tokens = coalesce(usage_input_tokens, 0) + coalesce(usage_output_tokens, 0)

#-----------------------------------------------------------------------------
# Safety, Guardrails, Policy
#-----------------------------------------------------------------------------
FIELDALIAS-idx_safety_violated_raw = safety_violated AS gen_ai.safety.violated_raw
FIELDALIAS-idx_safety_categories = safety_categories AS gen_ai.safety.categories
FIELDALIAS-idx_guardrail_triggered_raw = guardrail_triggered AS gen_ai.guardrail.triggered_raw
FIELDALIAS-idx_guardrail_ids = guardrail_ids AS gen_ai.guardrail.ids
FIELDALIAS-idx_pii_detected_raw = pii_detected AS gen_ai.pii.detected_raw
FIELDALIAS-idx_pii_types = pii_types AS gen_ai.pii.types
FIELDALIAS-idx_policy_blocked_raw = policy_blocked AS gen_ai.policy.blocked_raw

# Normalize booleans to consistent "true"/"false" strings
EVAL-gen_ai.safety.violated = case( \
    safety_violated=="true" OR safety_violated==1, "true", \
    safety_violated=="false" OR safety_violated==0, "false", \
    isnotnull(safety_violated), lower(safety_violated), \
    1=1, null())
EVAL-gen_ai.guardrail.triggered = case( \
    guardrail_triggered=="true" OR guardrail_triggered==1, "true", \
    guardrail_triggered=="false" OR guardrail_triggered==0, "false", \
    isnotnull(guardrail_triggered), lower(guardrail_triggered), \
    1=1, null())
EVAL-gen_ai.pii.detected = case( \
    pii_detected=="true" OR pii_detected==1, "true", \
    pii_detected=="false" OR pii_detected==0, "false", \
    isnotnull(pii_detected), lower(pii_detected), \
    1=1, null())
EVAL-gen_ai.policy.blocked = case( \
    policy_blocked=="true" OR policy_blocked==1, "true", \
    policy_blocked=="false" OR policy_blocked==0, "false", \
    isnotnull(policy_blocked), lower(policy_blocked), \
    1=1, null())

#-----------------------------------------------------------------------------
# Evaluation / TEVV / Drift
#-----------------------------------------------------------------------------
FIELDALIAS-idx_eval_score_value = evaluation_score_value AS gen_ai.evaluation.score.value
FIELDALIAS-idx_eval_score_label = evaluation_score_label AS gen_ai.evaluation.score.label
FIELDALIAS-idx_eval_explanation = evaluation_explanation AS gen_ai.evaluation.explanation
FIELDALIAS-idx_eval_name = evaluation_name AS gen_ai.evaluation.name
FIELDALIAS-idx_drift_metric_name = drift_metric_name AS gen_ai.drift.metric.name
FIELDALIAS-idx_drift_metric_value = drift_metric_value AS gen_ai.drift.metric.value
FIELDALIAS-idx_drift_status = drift_status AS gen_ai.drift.status

#-----------------------------------------------------------------------------
# Error and Infrastructure
#-----------------------------------------------------------------------------
FIELDALIAS-idx_error_type = error_type AS error.type
FIELDALIAS-idx_error_message = error_message AS error.message
FIELDALIAS-idx_status = status AS gen_ai.status
FIELDALIAS-idx_server_address = server_address AS server.address
FIELDALIAS-idx_server_port = server_port AS server.port

#-----------------------------------------------------------------------------
# Actor / Application Context
#-----------------------------------------------------------------------------
FIELDALIAS-idx_enduser = enduser_id AS enduser.id
FIELDALIAS-idx_service_name = service_name AS service.name
FIELDALIAS-idx_service_name_genai = service_name AS gen_ai.service.name
FIELDALIAS-idx_client_address = client_address AS client.address

# Derived: user ID with fallback
EVAL-gen_ai.user.id = coalesce(enduser_id, user_id, user)
# Derived: application name with fallback
EVAL-gen_ai.app.name = coalesce(service_name, app_name, app)

#-----------------------------------------------------------------------------
# Multi-value Field Extractions (via transforms.conf)
#-----------------------------------------------------------------------------
REPORT-idx_safety_categories = extract_safety_categories
REPORT-idx_guardrail_ids = extract_guardrail_ids
REPORT-idx_pii_types = extract_pii_types
REPORT-idx_finish_reasons = extract_finish_reasons
REPORT-idx_stop_sequences = extract_stop_sequences

###############################################################################
# SOURCETYPE-BASED NORMALIZATION (Secondary - for specific formats)
###############################################################################

# =============================================================================
# Medadvice v3 format (gen_ai_log index)
# =============================================================================
[medadvice3:json]
# Search-time JSON field extraction
KV_MODE = json
# Note: INDEXED_EXTRACTIONS should be set at index-time (on forwarders/indexers)
# Do NOT set index-time configs in search-time TAs for Cloud compatibility

# Core operation / model identity
FIELDALIAS-genai_operation = operation_name AS gen_ai.operation.name
FIELDALIAS-genai_provider = provider_name AS gen_ai.provider.name
FIELDALIAS-genai_model_request = request_model AS gen_ai.request.model
FIELDALIAS-genai_model_response = response_model AS gen_ai.response.model
FIELDALIAS-genai_response_id = response_id AS gen_ai.response.id
FIELDALIAS-genai_conversation_id = conversation_id AS gen_ai.conversation.id
FIELDALIAS-genai_deployment = deployment_id AS gen_ai.deployment.id
FIELDALIAS-genai_request_id = request_id AS gen_ai.request.id
FIELDALIAS-genai_session = session_id AS gen_ai.session.id
FIELDALIAS-genai_event_id = event_id AS gen_ai.event.id
FIELDALIAS-genai_trace = trace_id AS trace_id

# Input/output payload
# Handle both flat string fields and JSON array structures
FIELDALIAS-genai_system_instructions = system_instructions AS gen_ai.system_instructions
FIELDALIAS-genai_output_type = output_type AS gen_ai.output.type

# Extract text content from JSON array messages (input_messages[].content)
# mvjoin concatenates all content entries from the conversation
EVAL-gen_ai.input.messages = case( \
    isnotnull('input_messages{}.content'), mvjoin('input_messages{}.content', " "), \
    isnotnull(input_messages), input_messages, \
    1=1, null())
EVAL-gen_ai.output.messages = case( \
    isnotnull('output_messages{}.content'), mvjoin('output_messages{}.content', " "), \
    isnotnull(output_messages), output_messages, \
    1=1, null())

# Also expose the raw JSON arrays if needed
FIELDALIAS-genai_input_raw = input_messages AS gen_ai.input.messages_raw
FIELDALIAS-genai_output_raw = output_messages AS gen_ai.output.messages_raw

# Request parameters
FIELDALIAS-genai_token_type = token_type AS gen_ai.token.type
FIELDALIAS-genai_max_tokens = request_max_tokens AS gen_ai.request.max_tokens
FIELDALIAS-genai_temperature = request_temperature AS gen_ai.request.temperature
FIELDALIAS-genai_top_p = request_top_p AS gen_ai.request.top_p
FIELDALIAS-genai_frequency_penalty = request_frequency_penalty AS gen_ai.request.frequency_penalty
FIELDALIAS-genai_presence_penalty = request_presence_penalty AS gen_ai.request.presence_penalty
FIELDALIAS-genai_stop_sequences = request_stop_sequences AS gen_ai.request.stop_sequences
FIELDALIAS-genai_finish_reasons = response_finish_reasons AS gen_ai.response.finish_reasons
FIELDALIAS-genai_choice_count = request_choice_count AS gen_ai.request.choice.count
FIELDALIAS-genai_seed = request_seed AS gen_ai.request.seed

# Usage, performance, cost
FIELDALIAS-genai_input_tokens = usage_input_tokens AS gen_ai.usage.input_tokens
FIELDALIAS-genai_output_tokens = usage_output_tokens AS gen_ai.usage.output_tokens
FIELDALIAS-genai_duration = client_operation_duration AS gen_ai.client.operation.duration
FIELDALIAS-genai_cost = cost AS gen_ai.cost.total

# Computed fields
EVAL-gen_ai.usage.total_tokens = coalesce('gen_ai.usage.input_tokens', 0) + coalesce('gen_ai.usage.output_tokens', 0)

# Safety, guardrails, policy
FIELDALIAS-genai_safety_violated = safety_violated AS gen_ai.safety.violated
FIELDALIAS-genai_safety_categories = safety_categories AS gen_ai.safety.categories
FIELDALIAS-genai_guardrail_triggered = guardrail_triggered AS gen_ai.guardrail.triggered
FIELDALIAS-genai_guardrail_ids = guardrail_ids AS gen_ai.guardrail.ids
FIELDALIAS-genai_pii_detected = pii_detected AS gen_ai.pii.detected
FIELDALIAS-genai_pii_types = pii_types AS gen_ai.pii.types
FIELDALIAS-genai_policy_blocked = policy_blocked AS gen_ai.policy.blocked

# Normalize booleans
EVAL-gen_ai.safety.violated = if('gen_ai.safety.violated'=="true" OR 'gen_ai.safety.violated'==1 OR 'gen_ai.safety.violated'==true, "true", if('gen_ai.safety.violated'=="false" OR 'gen_ai.safety.violated'==0 OR 'gen_ai.safety.violated'==false, "false", null()))
EVAL-gen_ai.guardrail.triggered = if('gen_ai.guardrail.triggered'=="true" OR 'gen_ai.guardrail.triggered'==1 OR 'gen_ai.guardrail.triggered'==true, "true", if('gen_ai.guardrail.triggered'=="false" OR 'gen_ai.guardrail.triggered'==0 OR 'gen_ai.guardrail.triggered'==false, "false", null()))
EVAL-gen_ai.pii.detected = if('gen_ai.pii.detected'=="true" OR 'gen_ai.pii.detected'==1 OR 'gen_ai.pii.detected'==true, "true", if('gen_ai.pii.detected'=="false" OR 'gen_ai.pii.detected'==0 OR 'gen_ai.pii.detected'==false, "false", null()))
EVAL-gen_ai.policy.blocked = if('gen_ai.policy.blocked'=="true" OR 'gen_ai.policy.blocked'==1 OR 'gen_ai.policy.blocked'==true, "true", if('gen_ai.policy.blocked'=="false" OR 'gen_ai.policy.blocked'==0 OR 'gen_ai.policy.blocked'==false, "false", null()))

# Evaluation / TEVV / drift
FIELDALIAS-genai_eval_score_value = evaluation_score_value AS gen_ai.evaluation.score.value
FIELDALIAS-genai_eval_score_label = evaluation_score_label AS gen_ai.evaluation.score.label
FIELDALIAS-genai_eval_explanation = evaluation_explanation AS gen_ai.evaluation.explanation
FIELDALIAS-genai_eval_name = evaluation_name AS gen_ai.evaluation.name
FIELDALIAS-genai_drift_metric_name = drift_metric_name AS gen_ai.drift.metric.name
FIELDALIAS-genai_drift_metric_value = drift_metric_value AS gen_ai.drift.metric.value
FIELDALIAS-genai_drift_status = drift_status AS gen_ai.drift.status

# Error and infra
FIELDALIAS-genai_error_type = error_type AS error.type
FIELDALIAS-genai_status = status AS gen_ai.status
FIELDALIAS-genai_server_address = server_address AS server.address
FIELDALIAS-genai_server_port = server_port AS server.port

# Actor / application context
FIELDALIAS-genai_enduser = enduser_id AS enduser.id
FIELDALIAS-genai_service_name = service_name AS service.name
FIELDALIAS-genai_service_name_normalized = service_name AS gen_ai.service.name
FIELDALIAS-genai_client_address = client_address AS client.address
EVAL-gen_ai.user.id = coalesce('enduser.id', 'user')
EVAL-gen_ai.app.name = coalesce('service.name', 'app')

# Multi-value field extractions
REPORT-genai_extract_safety_categories = extract_safety_categories
REPORT-genai_extract_guardrail_ids = extract_guardrail_ids
REPORT-genai_extract_pii_types = extract_pii_types
REPORT-genai_extract_finish_reasons = extract_finish_reasons
REPORT-genai_extract_stop_sequences = extract_stop_sequences

# Review status enrichment - auto-lookup review findings (DISABLED)
# Maps gen_ai.event.id to _key in KV store, outputs underscore fields as dotted namespace
# LOOKUP-gen_ai_review_enrichment = gen_ai_review_findings_lookup gen_ai.event.id AS _key OUTPUTNEW gen_ai_review_status AS gen_ai.review.status, gen_ai_review_status AS is_escalated, gen_ai_review_assignee AS gen_ai.review.assignee, gen_ai_review_reviewer AS gen_ai.review.reviewer, gen_ai_review_priority AS gen_ai.review.priority, gen_ai_review_pii_confirmed AS gen_ai.review.pii_confirmed, gen_ai_review_phi_confirmed AS gen_ai.review.phi_confirmed, gen_ai_review_pii_types AS gen_ai.review.pii_types, gen_ai_review_phi_types AS gen_ai.review.phi_types, gen_ai_review_prompt_injection_confirmed AS gen_ai.review.prompt_injection_confirmed, gen_ai_review_anomaly_prompt_detected AS gen_ai.review.anomaly_prompt_detected, gen_ai_review_anomaly_prompt_reviewed AS gen_ai.review.anomaly_prompt_reviewed, gen_ai_review_anomaly_response_detected AS gen_ai.review.anomaly_response_detected, gen_ai_review_anomaly_response_reviewed AS gen_ai.review.anomaly_response_reviewed, gen_ai_review_notes AS gen_ai.review.notes, gen_ai_review_updated_at AS gen_ai.review.updated_at

###############################################################################
# Medadvice v2 format (ai_log2 index - nested event structure)
###############################################################################

# =============================================================================
# Medadvice v2 format (nested event structure)
# =============================================================================
[medadvice:json]
KV_MODE = json
# Note: Index-time settings removed for search-time TA compatibility

# Core operation / model identity (nested event fields)
FIELDALIAS-genai_provider = event.model_provider AS gen_ai.provider.name
FIELDALIAS-genai_model_request = event.model_id AS gen_ai.request.model
FIELDALIAS-genai_response_id = event.inference_id AS gen_ai.response.id
FIELDALIAS-genai_request_id = event.inference_id AS gen_ai.request.id
FIELDALIAS-genai_session = event.session_id AS gen_ai.session.id
FIELDALIAS-genai_event_id = event.event_id AS gen_ai.event.id
FIELDALIAS-genai_trace = event.trace_id AS trace_id

# Input/output payload
FIELDALIAS-genai_input = event.input AS gen_ai.input.messages
FIELDALIAS-genai_output = event.output AS gen_ai.output.messages

# Request parameters
FIELDALIAS-genai_max_tokens = event.max_tokens AS gen_ai.request.max_tokens
FIELDALIAS-genai_temperature = event.temperature AS gen_ai.request.temperature
FIELDALIAS-genai_top_p = event.top_p AS gen_ai.request.top_p

# Usage, performance, cost
FIELDALIAS-genai_input_tokens = event.input_size_tokens AS gen_ai.usage.input_tokens
FIELDALIAS-genai_output_tokens = event.output_size_tokens AS gen_ai.usage.output_tokens
FIELDALIAS-genai_cost = event.cost AS gen_ai.cost.total
EVAL-gen_ai.usage.total_tokens = coalesce('gen_ai.usage.input_tokens', 0) + coalesce('gen_ai.usage.output_tokens', 0)
EVAL-gen_ai.client.operation.duration = if(isnotnull('event.latency_ms'), 'event.latency_ms'/1000, null())

# Safety, guardrails, policy
FIELDALIAS-genai_safety_score = event.safety_score AS gen_ai.safety.score
FIELDALIAS-genai_safety_violated = event.safety_violated AS gen_ai.safety.violated
FIELDALIAS-genai_guardrail_triggered = event.guardrails_triggered AS gen_ai.guardrail.triggered
FIELDALIAS-genai_pii_detected = event.pii_detected AS gen_ai.pii.detected

# Normalize booleans to consistent "true"/"false" strings
EVAL-gen_ai.safety.violated = if('gen_ai.safety.violated'=="true" OR 'gen_ai.safety.violated'==1 OR 'gen_ai.safety.violated'==true, "true", if('gen_ai.safety.violated'=="false" OR 'gen_ai.safety.violated'==0 OR 'gen_ai.safety.violated'==false, "false", null()))
EVAL-gen_ai.guardrail.triggered = if('gen_ai.guardrail.triggered'=="true" OR 'gen_ai.guardrail.triggered'==1 OR 'gen_ai.guardrail.triggered'==true, "true", if('gen_ai.guardrail.triggered'=="false" OR 'gen_ai.guardrail.triggered'==0 OR 'gen_ai.guardrail.triggered'==false, "false", null()))
EVAL-gen_ai.pii.detected = if('gen_ai.pii.detected'=="true" OR 'gen_ai.pii.detected'==1 OR 'gen_ai.pii.detected'==true, "true", if('gen_ai.pii.detected'=="false" OR 'gen_ai.pii.detected'==0 OR 'gen_ai.pii.detected'==false, "false", null()))

# Error and infra
FIELDALIAS-genai_status = event.status AS gen_ai.status
FIELDALIAS-genai_error_message = event.error_message AS error.message

# Actor / application context
FIELDALIAS-genai_service_name = event.app AS service.name
FIELDALIAS-genai_service_name_normalized = event.app AS gen_ai.service.name
EVAL-gen_ai.app.name = coalesce('service.name', 'event.app')

# Multi-value field extractions
REPORT-genai_extract_guardrail_ids_alt = extract_guardrail_ids_alt

# Review status enrichment - auto-lookup review findings (DISABLED)
# Maps gen_ai.event.id to _key in KV store, outputs underscore fields as dotted namespace
# LOOKUP-gen_ai_review_enrichment = gen_ai_review_findings_lookup gen_ai.event.id AS _key OUTPUTNEW gen_ai_review_status AS gen_ai.review.status, gen_ai_review_status AS is_escalated, gen_ai_review_assignee AS gen_ai.review.assignee, gen_ai_review_reviewer AS gen_ai.review.reviewer, gen_ai_review_priority AS gen_ai.review.priority, gen_ai_review_pii_confirmed AS gen_ai.review.pii_confirmed, gen_ai_review_phi_confirmed AS gen_ai.review.phi_confirmed, gen_ai_review_prompt_injection_confirmed AS gen_ai.review.prompt_injection_confirmed, gen_ai_review_anomaly_prompt_detected AS gen_ai.review.anomaly_prompt_detected, gen_ai_review_anomaly_prompt_reviewed AS gen_ai.review.anomaly_prompt_reviewed, gen_ai_review_anomaly_response_detected AS gen_ai.review.anomaly_response_detected, gen_ai_review_anomaly_response_reviewed AS gen_ai.review.anomaly_response_reviewed

###############################################################################
# Fallback source-based stanzas (for other configurations)
# Note: KV_MODE=json enables search-time JSON parsing
###############################################################################

[source::*/gen_ai_log/*]
KV_MODE = json

[source::*/ai_log2/*]
KV_MODE = json
