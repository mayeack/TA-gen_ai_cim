#
# collections.conf - KV Store Collection Definitions
# TA-gen_ai_cim
#
# Defines KV store collections for GenAI governance data including
# time-versioned token pricing for cost calculations.
#

###############################################################################
# TOKEN COST COLLECTION
# Time-versioned pricing for input/output tokens by provider and model
###############################################################################

[genai_token_cost]
# Fields for time-versioned model pricing
# - provider: Cloud provider or vendor (e.g., "openai", "anthropic", "aws.bedrock")
# - model: Model identifier (e.g., "gpt-4", "claude-3-opus", "claude-3-5-sonnet-20241022")
# - direction: Token direction - "input" or "output"
# - cost_per_million: Cost in USD per million tokens
# - effective_start: Unix epoch timestamp when this price becomes effective
# - effective_end: Unix epoch timestamp when this price expires (null for current)
# - currency: Currency code (default: "USD")

field.provider = string
field.model = string
field.direction = string
field.cost_per_million = number
field.effective_start = number
field.effective_end = number
field.currency = string

# Enforce acceleration for fast lookups
accelerated_fields.provider_model_direction = {"provider": 1, "model": 1, "direction": 1}
accelerated_fields.effective_range = {"effective_start": 1, "effective_end": 1}

# Replicate to search heads for distributed deployments
replicate = true

###############################################################################
# SERVICENOW AI CASE MAPPING COLLECTION
# Maps gen_ai.event.id to ServiceNow AI Case sys_id for auditable linkage
###############################################################################

[gen_ai_snow_case_map]
# Fields for ServiceNow case mapping
# - event_id: GenAI event identifier (gen_ai.event.id), unique key
# - sys_id: ServiceNow AI Case sys_id
# - sn_instance: ServiceNow instance name (for multi-instance support)
# - created_at: Unix epoch when mapping was created
# - updated_at: Unix epoch when mapping was last updated
# - created_by: Username who created the case linkage

field.event_id = string
field.sys_id = string
field.sn_instance = string
field.created_at = number
field.updated_at = number
field.created_by = string

# Enforce uniqueness on event_id for deduplication
accelerated_fields.event_id_unique = {"event_id": 1}

# Secondary index on sys_id for reverse lookups
accelerated_fields.sys_id_lookup = {"sys_id": 1}

# Replicate to search heads for distributed deployments
replicate = true

###############################################################################
# REVIEW FINDINGS COLLECTION
# Stores analyst review outcomes for AI governance workflow
# Field names use underscore format for KV Store REST API compatibility
# (dotted field names don't work with REST API JSON payloads)
###############################################################################

[gen_ai_review_findings]
# Primary key fields for event identification
field.gen_ai_event_id = string
field.gen_ai_trace_id = string
field.event_time = number

# Event context fields
field.gen_ai_app_name = string
field.gen_ai_request_model = string
field.gen_ai_input_preview = string
field.gen_ai_output_preview = string

# Assignment and workflow fields
field.gen_ai_review_reviewer = string
field.gen_ai_review_assignee = string
field.gen_ai_review_status = string
field.gen_ai_review_priority = string

# PII findings
# gen_ai_review_pii_types: ML-detected PII types from event data
# gen_ai_review_pii_types_reviewed: Reviewer-confirmed PII types
field.gen_ai_review_pii_confirmed = bool
field.gen_ai_review_pii_types = string
field.gen_ai_review_pii_types_reviewed = string

# PHI findings
field.gen_ai_review_phi_confirmed = bool
field.gen_ai_review_phi_types = string

# Security findings
field.gen_ai_review_prompt_injection_confirmed = bool
field.gen_ai_review_prompt_injection_type = string

# Anomaly findings (from tfidf_combined_scoring)
field.gen_ai_review_anomaly_prompt_detected = string
field.gen_ai_review_anomaly_prompt_reviewed = string
field.gen_ai_review_anomaly_response_detected = string
field.gen_ai_review_anomaly_response_reviewed = string

# Reviewer notes and audit trail
field.gen_ai_review_notes = string
field.gen_ai_review_created_at = number
field.gen_ai_review_updated_at = number
field.gen_ai_review_created_by = string
field.gen_ai_review_updated_by = string

# Accelerate lookups on commonly queried fields
accelerated_fields.event_id = {"gen_ai_event_id": 1}
accelerated_fields.status = {"gen_ai_review_status": 1}
accelerated_fields.assignee = {"gen_ai_review_assignee": 1}
accelerated_fields.priority = {"gen_ai_review_priority": 1}
accelerated_fields.findings = {"gen_ai_review_pii_confirmed": 1, "gen_ai_review_phi_confirmed": 1, "gen_ai_review_prompt_injection_confirmed": 1}

# Replicate to search heads for distributed deployments
replicate = true

###############################################################################
# REVIEW AUDIT LOG COLLECTION
# Stores complete audit trail of review actions
###############################################################################

[gen_ai_review_audit]
field.audit_id = string
field.event_id = string
field.action = string
field.previous_status = string
field.new_status = string
field.changed_fields = string
field.user = string
field.timestamp = number
field.notes = string

accelerated_fields.event_id = {"event_id": 1}
accelerated_fields.timestamp = {"timestamp": 1}

replicate = true

###############################################################################
# PII FEEDBACK LOOP - MODEL REGISTRY
# Tracks model versions, metrics, and promotion status for active learning
###############################################################################

[pii_model_registry]
# Model identification
field.model_name = string
field.model_version = string
field.algorithm = string
field.feature_count = number

# Performance metrics
field.accuracy = number
field.precision = number
field.recall = number
field.f1_score = number
field.threshold = number

# Training data stats
field.training_samples = number
field.pii_samples = number
field.clean_samples = number
field.feedback_samples = number

# Model lifecycle
field.status = string
field.created_at = number
field.promoted_at = number
field.retired_at = number
field.created_by = string
field.promoted_by = string
field.notes = string

accelerated_fields.model_name = {"model_name": 1}
accelerated_fields.status = {"status": 1}
accelerated_fields.model_version = {"model_version": 1}

replicate = true

###############################################################################
# PII FEEDBACK LOOP - TRAINING FEEDBACK
# Stores human-labeled data from Event Review for model retraining
# Uses reviewer-confirmed PII types (pii_types_reviewed) as ground truth labels
###############################################################################

[pii_training_feedback]
# Event identification
field.event_id = string
field.trace_id = string

# Response content for training
field.response_text = string
field.response_length = number

# Human labels from review (ground truth)
field.pii_label = number
field.pii_types = string
field.pii_types_reviewed = string
field.phi_confirmed = bool
field.reviewer = string
field.review_completed_at = number

# Per-type ground truth labels (from reviewer-confirmed types)
# These are derived from pii_types_reviewed for granular model training
field.has_ssn_label = number
field.has_email_label = number
field.has_phone_label = number
field.has_dob_label = number
field.has_address_label = number
field.has_credit_card_label = number
field.has_name_label = number

# ML model predictions (for comparison)
field.ml_predicted_score = number
field.ml_predicted_label = string
field.ml_predicted_types = string
field.ml_model_version = string

# Feedback classification
# Types: confirmed_pii_exact, confirmed_pii_type_mismatch, false_negative, false_positive, confirmed_clean
field.feedback_type = string

# Data split assignment
field.split_assignment = string

# Feature values (cached for training - extracted from response text)
field.output_length = number
field.word_count = number
field.digit_ratio = number
field.special_char_ratio = number
field.uppercase_ratio = number
field.has_ssn = number
field.has_email = number
field.has_phone = number
field.has_dob = number
field.has_address = number
field.has_credit_card = number
field.has_name = number

# Metadata
field.extracted_at = number
field.app_name = string
field.model_name = string

accelerated_fields.event_id = {"event_id": 1}
accelerated_fields.split = {"split_assignment": 1}
accelerated_fields.feedback_type = {"feedback_type": 1}
accelerated_fields.pii_label = {"pii_label": 1}
accelerated_fields.type_labels = {"has_ssn_label": 1, "has_email_label": 1, "has_name_label": 1}

replicate = true

###############################################################################
# PII FEEDBACK LOOP - THRESHOLD TUNING RESULTS
# Stores threshold analysis results for model evaluation
###############################################################################

[pii_threshold_results]
# Model identification
field.model_name = string
field.model_version = string
field.analysis_date = number

# Threshold being evaluated
field.threshold = number

# Confusion matrix
field.true_positives = number
field.false_positives = number
field.true_negatives = number
field.false_negatives = number

# Derived metrics
field.precision = number
field.recall = number
field.f1_score = number
field.accuracy = number
field.specificity = number

# Sample counts
field.total_samples = number
field.validation_samples = number

# Recommendation
field.is_optimal = bool
field.notes = string

accelerated_fields.model_version = {"model_version": 1}
accelerated_fields.threshold = {"threshold": 1}

replicate = true

###############################################################################
# PROMPT INJECTION FEEDBACK LOOP - MODEL REGISTRY
# Tracks model versions, metrics, and promotion status for active learning
###############################################################################

[prompt_injection_model_registry]
# Model identification
field.model_name = string
field.model_version = string
field.algorithm = string
field.feature_count = number

# Performance metrics
field.accuracy = number
field.precision = number
field.recall = number
field.f1_score = number
field.threshold = number

# Training data stats
field.training_samples = number
field.attack_samples = number
field.clean_samples = number
field.feedback_samples = number

# Model lifecycle
field.status = string
field.created_at = number
field.promoted_at = number
field.retired_at = number
field.created_by = string
field.promoted_by = string
field.notes = string

accelerated_fields.model_name = {"model_name": 1}
accelerated_fields.status = {"status": 1}
accelerated_fields.model_version = {"model_version": 1}

replicate = true

###############################################################################
# PROMPT INJECTION FEEDBACK LOOP - TRAINING FEEDBACK
# Stores human-labeled data from Event Review for model retraining
# Uses reviewer-confirmed injection types as ground truth labels
###############################################################################

[prompt_injection_training_feedback]
# Event identification
field.event_id = string
field.trace_id = string

# Prompt content for training
field.input_text = string
field.prompt_length = number

# Human labels from review (ground truth)
field.injection_label = number
field.injection_technique = string
field.technique_reviewed = string
field.reviewer = string
field.review_completed_at = number

# Per-technique ground truth labels (from reviewer-confirmed types)
field.has_ignore_instruction_label = number
field.has_reveal_request_label = number
field.has_bypass_request_label = number
field.has_roleplay_injection_label = number
field.has_jailbreak_terms_label = number
field.has_encoding_label = number

# ML model predictions (for comparison)
field.ml_predicted_score = number
field.ml_predicted_label = string
field.ml_predicted_technique = string
field.ml_model_version = string

# Feedback classification
# Types: confirmed_attack_exact, confirmed_attack_technique_mismatch, false_negative, false_positive, confirmed_clean
field.feedback_type = string

# Data split assignment
field.split_assignment = string

# Feature values (cached for training - extracted from input text)
field.word_count = number
field.special_char_ratio = number
field.negation_density = number
field.has_ignore_instruction = number
field.has_reveal_request = number
field.has_bypass_request = number
field.has_roleplay_injection = number
field.has_jailbreak_terms = number
field.has_encoding = number
field.starts_with_command = number

# Metadata
field.extracted_at = number
field.app_name = string
field.model_name = string

accelerated_fields.event_id = {"event_id": 1}
accelerated_fields.split = {"split_assignment": 1}
accelerated_fields.feedback_type = {"feedback_type": 1}
accelerated_fields.injection_label = {"injection_label": 1}
accelerated_fields.technique_labels = {"has_ignore_instruction_label": 1, "has_jailbreak_terms_label": 1, "has_bypass_request_label": 1}

replicate = true

###############################################################################
# PROMPT INJECTION FEEDBACK LOOP - THRESHOLD TUNING RESULTS
# Stores threshold analysis results for model evaluation
###############################################################################

[prompt_injection_threshold_results]
# Model identification
field.model_name = string
field.model_version = string
field.analysis_date = number

# Threshold being evaluated
field.threshold = number

# Confusion matrix
field.true_positives = number
field.false_positives = number
field.true_negatives = number
field.false_negatives = number

# Derived metrics
field.precision = number
field.recall = number
field.f1_score = number
field.accuracy = number
field.specificity = number

# Sample counts
field.total_samples = number
field.validation_samples = number

# Recommendation
field.is_optimal = bool
field.notes = string

accelerated_fields.model_version = {"model_version": 1}
accelerated_fields.threshold = {"threshold": 1}

replicate = true

###############################################################################
# TF-IDF ANOMALY FEEDBACK LOOP - MODEL REGISTRY
# Tracks model versions, metrics, and promotion status for active learning
###############################################################################

[tfidf_model_registry]
# Model identification
field.model_name = string
field.model_type = string
field.model_version = string
field.algorithm = string
field.feature_count = number

# Performance metrics
field.precision = number
field.recall = number
field.f1_score = number
field.threshold = number

# Training data stats
field.training_samples = number
field.feedback_samples = number
field.original_samples = number

# Model lifecycle
field.status = string
field.created_at = number
field.promoted_at = number
field.retired_at = number
field.created_by = string
field.promoted_by = string
field.notes = string

accelerated_fields.model_name = {"model_name": 1}
accelerated_fields.model_type = {"model_type": 1}
accelerated_fields.status = {"status": 1}
accelerated_fields.model_version = {"model_version": 1}

replicate = true

###############################################################################
# TF-IDF ANOMALY FEEDBACK LOOP - TRAINING FEEDBACK
# Stores human-confirmed normal examples from Event Review for model retraining
# Only records where reviewer marked anomaly as FALSE (True Negative)
# TRUE and n/a reviews are IGNORED
###############################################################################

[tfidf_training_feedback]
# Event identification
field.gen_ai_event_id = string
field.trace_id = string
field.feedback_timestamp = number

# Content for training (only populated when reviewer marks FALSE)
field.prompt_text = string
field.response_text = string

# Flags indicating which feedback was provided
field.has_prompt_feedback = bool
field.has_response_feedback = bool

# Context from original event
field.app_name = string
field.model_name = string

# Data split assignment
field.split_assignment = string

# Reviewer info
field.reviewer = string
field.review_completed_at = number

accelerated_fields.event_id = {"gen_ai_event_id": 1}
accelerated_fields.split = {"split_assignment": 1}
accelerated_fields.feedback_flags = {"has_prompt_feedback": 1, "has_response_feedback": 1}

replicate = true

###############################################################################
# TF-IDF ANOMALY FEEDBACK LOOP - THRESHOLD TUNING RESULTS
# Stores threshold analysis results for model evaluation
###############################################################################

[tfidf_threshold_results]
# Model identification
field.model_name = string
field.model_type = string
field.model_version = string
field.analysis_date = number

# Threshold being evaluated
field.threshold = number

# Metrics
field.total_samples = number
field.anomaly_count = number
field.normal_count = number
field.anomaly_rate = number

# Score distribution
field.avg_score = number
field.std_score = number
field.min_score = number
field.max_score = number
field.p10_score = number
field.p50_score = number
field.p90_score = number

# Recommendation
field.is_optimal = bool
field.notes = string

accelerated_fields.model_version = {"model_version": 1}
accelerated_fields.model_type = {"model_type": 1}
accelerated_fields.threshold = {"threshold": 1}

replicate = true

###############################################################################
# SERVICENOW AI SYSTEM DIGITAL ASSET MAPPING COLLECTION
# Maps gen_ai.app.name to ServiceNow alm_ai_system_digital_asset sys_id
###############################################################################

[gen_ai_app_asset_map]
# Fields for ServiceNow AI System Digital Asset mapping
# - gen_ai_app_name: GenAI application name (gen_ai.app.name), unique key
# - service_now_sys_id: ServiceNow alm_ai_system_digital_asset sys_id
# - sync_status: Status of sync - "found" (existing in ServiceNow) or "created" (newly created)
# - created_at: Unix epoch when mapping was created
# - updated_at: Unix epoch when mapping was last updated
# - created_by: Username who created the mapping

field.gen_ai_app_name = string
field.service_now_sys_id = string
field.sync_status = string
field.created_at = number
field.updated_at = number
field.created_by = string

# Enforce uniqueness on gen_ai_app_name for deduplication
accelerated_fields.app_name_unique = {"gen_ai_app_name": 1}

# Secondary index on service_now_sys_id for reverse lookups
accelerated_fields.sys_id_lookup = {"service_now_sys_id": 1}

# Replicate to search heads for distributed deployments
replicate = true
